<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PFL Admin Panel</title>
<style>
body { margin:0; font-family: Arial, sans-serif; background:#111; color:#fff; }
header { background: gold; color:black; text-align:center; font-weight:bold; padding:15px;}
.container {padding:10px; max-width:1200px; margin:auto;}
.card {background:#222; border:1px solid gold; border-radius:8px; padding:10px; margin-bottom:10px;}
label {display:block; margin-top:5px;}
input, select {margin-top:3px; padding:5px; border-radius:4px; border:none; width:100%;}
button {margin-top:10px; padding:10px; background:gold; color:black; border:none; border-radius:5px; cursor:pointer;}
h2 {margin-top:20px;}
</style>
</head>
<body>
<header>PFL Admin Panel</header>
<div class="container">
<div id="loginDiv">
  <h2>Admin Login</h2>
  <label>Password:</label>
  <input type="password" id="adminPassword" placeholder="Enter password">
  <button onclick="login()">Login</button>
</div>

<div id="adminDiv" style="display:none;">
  <h2>Update Matches</h2>
  <label>Select Match Day:</label>
  <select id="matchDaySelect"></select>

  <div id="matchesContainer"></div>
  <button onclick="saveData()">Save Updates</button>
</div>
</div>

<script>
const ADMIN_PASS = "Rowland12#";
const GITHUB_REPO = "rowlandmayowa527-ai/pfl-livescore-center";
const DATA_FILE = "data.json";
const GITHUB_PAT = "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"; // Replace with your PAT

let data = {};

function login(){
  const pass = document.getElementById("adminPassword").value;
  if(pass===ADMIN_PASS){
    document.getElementById("loginDiv").style.display="none";
    document.getElementById("adminDiv").style.display="block";
    loadData();
  } else { alert("Incorrect password"); }
}

async function loadData(){
  try {
    const res = await fetch(`https://raw.githubusercontent.com/${GITHUB_REPO}/main/${DATA_FILE}?t=${Date.now()}`);
    data = await res.json();
    populateMatchDays();
  } catch(e){
    alert("Failed to load data.json from GitHub");
    console.error(e);
  }
}

function populateMatchDays(){
  const select = document.getElementById("matchDaySelect");
  select.innerHTML="";
  data.matchDays.forEach((day,i)=>{
    const opt=document.createElement("option");
    opt.value=i;
    opt.text=`Match Day ${i+1} - ${day.date}`;
    select.appendChild(opt);
  });
  select.onchange = renderMatches;
  renderMatches();
}

function renderMatches(){
  const idx = document.getElementById("matchDaySelect").value;
  const container = document.getElementById("matchesContainer");
  container.innerHTML="";
  const matchDay = data.matchDays[idx];
  matchDay.matches.forEach((m,i)=>{
    const card = document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <label>Home Team:</label>
      <select id="home-${i}">${data.teams.map(t=>`<option value="${t}" ${t===m.home?'selected':''}>${t}</option>`)}</select>

      <label>Away Team:</label>
      <select id="away-${i}">${data.teams.map(t=>`<option value="${t}" ${t===m.away?'selected':''}>${t}</option>`)}</select>

      <label>Home Score:</label>
      <input type="number" min="0" max="6" value="${m.homeScore!==null?m.homeScore:0}" id="hs-${i}">

      <label>Away Score:</label>
      <input type="number" min="0" max="6" value="${m.awayScore!==null?m.awayScore:0}" id="as-${i}">

      <label>Venue:</label>
      <select id="venue-${i}">
        <option value="Mainbowl" ${m.venue==="Mainbowl"?'selected':''}>Mainbowl</option>
        <option value="Maracana" ${m.venue==="Maracana"?'selected':''}>Maracana</option>
      </select>

      <label>Time:</label>
      <input type="time" value="${m.time}" id="time-${i}">

      <label>Live:</label>
      <select id="live-${i}">
        <option value="true" ${m.live?'selected':''}>Yes</option>
        <option value="false" ${!m.live?'selected':''}>No</option>
      </select>
    `;
    container.appendChild(card);
  });
}

async function saveData(){
  const idx = document.getElementById("matchDaySelect").value;
  const matchDay = data.matchDays[idx];
  matchDay.matches.forEach((m,i)=>{
    m.home = document.getElementById(`home-${i}`).value;
    m.away = document.getElementById(`away-${i}`).value;
    m.homeScore = parseInt(document.getElementById(`hs-${i}`).value);
    m.awayScore = parseInt(document.getElementById(`as-${i}`).value);
    m.venue = document.getElementById(`venue-${i}`).value;
    m.time = document.getElementById(`time-${i}`).value;
    m.live = document.getElementById(`live-${i}`).value==="true";
  });

  try {
    // Convert JSON to Base64
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(data,null,2))));

    // Get latest SHA
    const shaRes = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${DATA_FILE}`,{
      headers: { "Authorization": `token ${GITHUB_PAT}` }
    });
    const shaData = await shaRes.json();
    const sha = shaData.sha;

    // PUT request to update
    const res = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${DATA_FILE}`,{
      method:"PUT",
      headers:{
        "Authorization": `token ${GITHUB_PAT}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: "Update via Admin Panel",
        content,
        sha
      })
    });

    if(res.ok){ alert("Data updated successfully!"); loadData(); }
    else { 
      const err = await res.json();
      console.error(err);
      alert("Update failed! Check console for details.");
    }

  } catch(e){
    console.error(e);
    alert("Update failed! Check console for details.");
  }
}
</script>
</body>
</html>
