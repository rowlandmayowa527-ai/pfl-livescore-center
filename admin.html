<!DOCTYPE html>
<html>
<head>
  <title>PFL Admin Panel</title>
  <style>
    body { font-family: sans-serif; background:#000; color:#fff; padding:20px;}
    input, button, textarea { width:100%; margin:5px 0; padding:8px; }
    label { margin-top:10px; display:block; }
    h2 { color: gold; }
  </style>
</head>
<body>
  <h2>PFL Admin Panel</h2>

  <label>Home Team Name:</label>
  <input type="text" id="homeTeam">

  <label>Away Team Name:</label>
  <input type="text" id="awayTeam">

  <label>Home Score:</label>
  <input type="number" id="homeScore" value="0">

  <label>Away Score:</label>
  <input type="number" id="awayScore" value="0">

  <label>Substitutions / Notes (one per line):</label>
  <textarea id="subs" rows="3"></textarea>

  <label>Home Form (W/D/L):</label>
  <input type="text" id="homeForm">

  <label>Away Form:</label>
  <input type="text" id="awayForm">

  <label>Home Player Ratings (Player1-8,Player2-7,...):</label>
  <input type="text" id="homeRatings">

  <label>Away Player Ratings:</label>
  <input type="text" id="awayRatings">

  <label>Home Goals / Assists / Yellow Cards / Red Cards (format: goals,assists,yellow,red):</label>
  <input type="text" id="homeStats">

  <label>Away Goals / Assists / Yellow Cards / Red Cards:</label>
  <input type="text" id="awayStats">

  <h3>Next Fixture (optional)</h3>
  <label>Home Team:</label>
  <input type="text" id="nextHome">
  <label>Away Team:</label>
  <input type="text" id="nextAway">
  <label>Match Date:</label>
  <input type="date" id="nextDate">

  <button onclick="updateMatch()">Save Match / Fixture</button>

  <script>
    function updateMatch() {
      const matchData = {
        homeTeam: document.getElementById('homeTeam').value,
        awayTeam: document.getElementById('awayTeam').value,
        homeScore: parseInt(document.getElementById('homeScore').value),
        awayScore: parseInt(document.getElementById('awayScore').value),
        subs: document.getElementById('subs').value.split('\n'),
        homeForm: document.getElementById('homeForm').value,
        awayForm: document.getElementById('awayForm').value,
        homeRatings: document.getElementById('homeRatings').value.split(','),
        awayRatings: document.getElementById('awayRatings').value.split(','),
        homeStats: document.getElementById('homeStats').value.split(',').map(Number),
        awayStats: document.getElementById('awayStats').value.split(',').map(Number),
        timestamp: new Date().toISOString()
      };

      // Current match
      localStorage.setItem('currentMatch', JSON.stringify(matchData));

      // Archive match
      let archive = JSON.parse(localStorage.getItem('matchArchive')) || [];
      archive = archive.filter(m => m.timestamp !== matchData.timestamp);
      archive.push(matchData);
      localStorage.setItem('matchArchive', JSON.stringify(archive));

      // Save next fixture
      let fixtures = JSON.parse(localStorage.getItem('nextFixtures')) || [];
      const nextHome = document.getElementById('nextHome').value;
      const nextAway = document.getElementById('nextAway').value;
      const nextDate = document.getElementById('nextDate').value;
      if(nextHome && nextAway && nextDate){
        fixtures.push({home: nextHome, away: nextAway, date: nextDate});
        localStorage.setItem('nextFixtures', JSON.stringify(fixtures));
      }

      alert('Match and fixture saved ✅');
    }
  </script>
</body>
</html>
        <div class="row">
          <div style="flex:1">
            <label class="muted">Home logo</label>
            <input id="homeLogoFile" type="file" accept="image/*" />
          </div>
          <div style="flex:1">
            <label class="muted">Away logo</label>
            <input id="awayLogoFile" type="file" accept="image/*" />
          </div>
        </div>

        <div style="display:flex; gap:8px; margin-top:6px;">
          <button id="createMatchBtn" class="primary">Create Match</button>
          <button id="refreshMatches" class="small">Refresh</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="muted">Matches</div>
    <div class="match-list" id="matchList"></div>
  </div>

  <div class="card" id="matchEditorCard" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div id="editingTitle" style="font-weight:800;">Editing match</div>
      <div style="display:flex; gap:8px;">
        <button id="setLiveBtn" class="primary small">Set Live</button>
        <button id="endMatchBtn" class="small">End Match</button>
      </div>
    </div>

    <div style="margin-top:10px;">
      <div class="row">
        <div style="flex:1">
          <div class="muted">Home</div>
          <div><input id="editHomeName" /></div>
          <div class="muted">Score</div>
          <div><input id="editHomeScore" type="number" min="0" /></div>
        </div>
        <div style="flex:1">
          <div class="muted">Away</div>
          <div><input id="editAwayName" /></div>
          <div class="muted">Score</div>
          <div><input id="editAwayScore" type="number" min="0" /></div>
        </div>
      </div>

      <div style="margin-top:8px;">
        <div class="muted">Add event (minute + description)</div>
        <div class="row" style="margin-top:6px;">
          <input id="evtMinute" placeholder="e.g. 23 or 45+2" />
          <input id="evtDesc" placeholder="Player X - Goal" style="flex:1" />
          <select id="evtTeam">
            <option value="">Match</option>
            <option value="A">Home</option>
            <option value="B">Away</option>
          </select>
          <button id="addEventBtn" class="primary">Add</button>
        </div>

        <div style="margin-top:10px;">
          <div class="muted">Events (most recent first)</div>
          <div id="evtList" style="max-height:180px; overflow:auto; margin-top:6px;"></div>
        </div>

        <div style="display:flex; gap:8px; margin-top:10px;">
          <button id="saveMatchBtn" class="primary">Save changes</button>
          <button id="deleteMatchBtn" class="small">Delete match</button>
        </div>
      </div>
    </div>
  </div>

</div>

<script type="module">
  import { listenMatches, pushMatch, updateMatch, uploadLogoFile, getMatchOnce } from './firebase.js';

  // Admin password (client-side): Rowland12#
  const ADMIN_PASS = 'Rowland12#';

  const passInput = document.getElementById('passInput');
  const unlockBtn = document.getElementById('unlockBtn');
  const adminControls = document.getElementById('adminControls');
  const matchList = document.getElementById('matchList');
  const matchEditorCard = document.getElementById('matchEditorCard');

  const homeName = document.getElementById('homeName');
  const awayName = document.getElementById('awayName');
  const homeCoach = document.getElementById('homeCoach');
  const awayCoach = document.getElementById('awayCoach');
  const homePlayers = document.getElementById('homePlayers');
  const awayPlayers = document.getElementById('awayPlayers');
  const homeLogoFile = document.getElementById('homeLogoFile');
  const awayLogoFile = document.getElementById('awayLogoFile');
  const createMatchBtn = document.getElementById('createMatchBtn');
  const refreshMatches = document.getElementById('refreshMatches');

  let matchesCache = [];
  let editingMatchId = null;

  unlockBtn.addEventListener('click', ()=>{
    if(passInput.value === ADMIN_PASS){
      passInput.value = '';
      adminControls.style.display = 'block';
      alert('Admin unlocked.');
    } else {
      alert('Wrong password.');
    }
  });

  // Create match
  createMatchBtn.addEventListener('click', async ()=>{
    if(!homeName.value.trim() || !awayName.value.trim()){ alert('Enter both team names'); return; }
    createMatchBtn.disabled = true;
    createMatchBtn.textContent = 'Creating...';
    // upload logos if provided
    let homeLogoUrl = '';
    let awayLogoUrl = '';
    if(homeLogoFile.files && homeLogoFile.files[0]){
      homeLogoUrl = await uploadLogoFile(homeLogoFile.files[0], 'team_home');
    }
    if(awayLogoFile.files && awayLogoFile.files[0]){
      awayLogoUrl = await uploadLogoFile(awayLogoFile.files[0], 'team_away');
    }
    const matchObj = {
      home: { name: homeName.value.trim(), coach: homeCoach.value.trim()||'', players: homePlayers.value.split(',').map(s=>s.trim()).filter(Boolean), logoUrl: homeLogoUrl, score: 0 },
      away: { name: awayName.value.trim(), coach: awayCoach.value.trim()||'', players: awayPlayers.value.split(',').map(s=>s.trim()).filter(Boolean), logoUrl: awayLogoUrl, score: 0 },
      status: 'not_started',
      events: []
    };
    try{
      const key = await pushMatch(matchObj);
      alert('Match created.');
      homeName.value=''; awayName.value=''; homeCoach.value=''; awayCoach.value=''; homePlayers.value=''; awayPlayers.value=''; homeLogoFile.value=''; awayLogoFile.value='';
    }catch(e){
      console.error(e); alert('Failed creating match: '+e.message);
    } finally {
      createMatchBtn.disabled = false;
      createMatchBtn.textContent = 'Create Match';
    }
  });

  // Listen matches in real-time and render list
  listenMatches((matches)=>{
    matchesCache = matches || [];
    renderMatchList();
    // If currently editing a match, refresh its editor data
    if(editingMatchId){ refreshEditor(editingMatchId); }
  });

  function renderMatchList(){
    matchList.innerHTML = '';
    if(!matchesCache.length){ matchList.innerHTML = '<div class="muted">No matches yet</div>'; return; }
    // newest first
    matchesCache.sort((a,b)=> (b.createdAt||'').localeCompare(a.createdAt||''));
    matchesCache.forEach(m=>{
      const div = document.createElement('div'); div.className='match-item';
      div.innerHTML = `<div>
          <div style="font-weight:700">${m.home?.name||'Home'} vs ${m.away?.name||'Away'}</div>
          <div class="muted">${m.status || 'not_started'} • ${new Date(m.createdAt||'').toLocaleString()}</div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="small" data-id="${m.id}" data-act="edit">Edit</button>
          <button class="small" data-id="${m.id}" data-act="setLive">Live</button>
          <button class="small" data-id="${m.id}" data-act="end">End</button>
        </div>`;
      matchList.appendChild(div);
    });
    // attach clicks
    matchList.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const id = btn.getAttribute('data-id');
        const act = btn.getAttribute('data-act');
        if(act==='edit') openEditor(id);
        else if(act==='setLive') setMatchLive(id);
        else if(act==='end') endMatch(id);
      });
    });
  }

  async function openEditor(id){
    editingMatchId = id;
    matchEditorCard.style.display = 'block';
    document.getElementById('editingTitle').textContent = 'Editing match';
    refreshEditor(id);
  }

  async function refreshEditor(id){
    const m = matchesCache.find(x=>x.id===id);
    if(!m) return;
    document.getElementById('editHomeName').value = m.home?.name || '';
    document.getElementById('editAwayName').value = m.away?.name || '';
    document.getElementById('editHomeScore').value = m.home?.score || 0;
    document.getElementById('editAwayScore').value = m.away?.score || 0;
    // render events
    const el = document.getElementById('evtList');
    el.innerHTML = '';
    (m.events||[]).forEach(ev=>{
      const d = document.createElement('div'); d.style.padding='6px'; d.style.borderBottom='1px solid rgba(255,255,255,0.03)';
      d.innerHTML = `<div style="font-weight:700">${ev.minute} — ${ev.type}</div><div class="muted">${ev.desc}</div>`;
      el.appendChild(d);
    });
    // save button
    document.getElementById('saveMatchBtn').onclick = async ()=>{
      const patch = {
        home: { ...m.home, name: document.getElementById('editHomeName').value.trim(), score: Number(document.getElementById('editHomeScore').value||0) },
        away: { ...m.away, name: document.getElementById('editAwayName').value.trim(), score: Number(document.getElementById('editAwayScore').value||0) }
      };
      await updateMatch(id, patch);
      alert('Saved.');
    };
    document.getElementById('deleteMatchBtn').onclick = async ()=>{
      if(!confirm('Delete match permanently?')) return;
      // remove by setting null
      await updateMatch(id, { deleted: true, status: 'deleted' });
      alert('Marked deleted (it will be hidden).');
    };
    document.getElementById('addEventBtn').onclick = async ()=>{
      const minute = document.getElementById('evtMinute').value.trim() || '';
      const desc = document.getElementById('evtDesc').value.trim();
      const team = document.getElementById('evtTeam').value || '';
      if(!desc){ alert('Add description'); return; }
      const ev = { type: desc.split('-')[0] || 'Event', minute: minute || new Date().getMinutes().toString(), desc, team, timestamp: new Date().toISOString() };
      const newEvents = [ev].concat(m.events || []);
      await updateMatch(id, { events: newEvents });
      document.getElementById('evtMinute').value=''; document.getElementById('evtDesc').value='';
      alert('Event added.');
    };
    document.getElementById('setLiveBtn').onclick = async ()=>{
      // set all matches to not live, then set this one live
      // naive approach: iterate cached matches
      for(const mm of matchesCache){
        await updateMatch(mm.id, { status: mm.id === id ? 'live' : (mm.status === 'deleted' ? 'deleted' : 'finished') });
      }
      alert('Match set to LIVE.');
    };
    document.getElementById('endMatchBtn').onclick = async ()=>{
      await updateMatch(id, { status: 'finished' });
      alert('Match ended.');
    };
  }

  async function setMatchLive(id){
    // same as setLiveBtn but simple
    for(const mm of matchesCache){
      await updateMatch(mm.id, { status: mm.id === id ? 'live' : (mm.status === 'deleted' ? 'deleted' : 'finished') });
    }
    alert('Match set to LIVE.');
  }
  async function endMatch(id){
    await updateMatch(id, { status: 'finished' });
    alert('Match ended.');
  }

  refreshMatches.addEventListener('click', ()=> renderMatchList());

  // convenience: upload logo and replace in match (not in create) - handled in editor if needed via prompt+file
  // (uploadLogoFile is used during create above)
</script>
</body>
  </html>
