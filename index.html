<!DOCTYPE html>
<html>
<head>
  <title>PFL Live Score</title>
  <style>
    body { font-family: sans-serif; background: #000; color: #fff; text-align:center; }
    .team { display:inline-block; width:45%; font-size: 1.5em; }
    .score { font-size: 3em; margin: 0 20px; color: gold; transition: color 0.5s; }
    .goal { color: red !important; }
    .subs { font-size: 1em; margin-top: 10px; color: #ccc; }
    hr { border-color: #444; margin: 20px 0; }
  </style>
</head>
<body>
  <h1>üèÜ Pinnacle Football League</h1>

  <div id="liveMatch">
    <div class="team" id="homeTeam"></div>
    <span class="score" id="homeScore">0</span>
    <span class="score">:</span>
    <span class="score" id="awayScore">0</span>
    <div class="team" id="awayTeam"></div>
    <div class="subs" id="subs"></div>
  </div>

  <h2>Previous Matches</h2>
  <div id="archive"></div>

  <audio id="goalSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

  <script>
    let lastHomeScore = 0;
    let lastAwayScore = 0;

    function loadMatch() {
      const matchData = JSON.parse(localStorage.getItem('currentMatch'));
      if(matchData) {
        document.getElementById('homeTeam').innerText = matchData.homeTeam;
        document.getElementById('awayTeam').innerText = matchData.awayTeam;
        document.getElementById('subs').innerHTML = matchData.subs.join('<br>');

        const homeScoreEl = document.getElementById('homeScore');
        const awayScoreEl = document.getElementById('awayScore');

        if(matchData.homeScore > lastHomeScore) flashGoal(homeScoreEl);
        if(matchData.awayScore > lastAwayScore) flashGoal(awayScoreEl);

        homeScoreEl.innerText = matchData.homeScore;
        awayScoreEl.innerText = matchData.awayScore;

        lastHomeScore = matchData.homeScore;
        lastAwayScore = matchData.awayScore;
      }

      loadArchive();
    }

    function flashGoal(element) {
      const sound = document.getElementById('goalSound');
      sound.play();
      element.classList.add('goal');
      setTimeout(() => element.classList.remove('goal'), 1000);
    }

    function loadArchive() {
      const archive = JSON.parse(localStorage.getItem('matchArchive')) || [];
      const archiveDiv = document.getElementById('archive');
      archiveDiv.innerHTML = '';

      archive.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

      archive.forEach(match => {
        archiveDiv.innerHTML += `
          <div>
            <strong>${match.homeTeam} ${match.homeScore} : ${match.awayScore} ${match.awayTeam}</strong><br>
            <small>${match.subs.join(', ')}</small>
            <hr>
          </div>
        `;
      });
    }

    loadMatch();
    setInterval(loadMatch, 3000);
  </script>
</body>
</html>  <div>
    <div class="title">Pinnacle Football League ‚Äî LiveScore</div>
    <div class="subtitle">Powered by Arcane Override Games (AOG)</div>
  </div>
  <div style="margin-left:auto;"><img id="aogRepoLogo" class="logo" src="aog-logo.png" alt="AOG logo" style="width:48px;height:48px;"></div>
</header>

<main class="wrap">
  <div class="card">
    <div class="controls">
      <div class="meta">Live matches are highlighted. Past results remain accessible.</div>
      <div><a href="admin.html" style="color:var(--gold); font-weight:700; text-decoration:none;">Admin panel</a></div>
    </div>

    <div class="fixture-list card" id="fixturesRoot">
      <!-- matches inserted here -->
      <div class="muted">Loading matches‚Ä¶</div>
    </div>
  </div>
</main>

<footer>¬© <strong>Arcane Override Games</strong> ‚Äî Pinnacle Football League</footer>

<script type="module">
  import { listenMatches } from './firebase.js';

  const fixturesRoot = document.getElementById('fixturesRoot');
  const pflRepoLogo = document.getElementById('pflRepoLogo');
  const aogRepoLogo = document.getElementById('aogRepoLogo');

  // If you uploaded repo logos named exactly pfl-logo.png / aog-logo.png they'll show.
  // Admin uploads replace per-match logos stored in DB.

  function renderMatches(matches){
    if(!matches.length){ fixturesRoot.innerHTML = '<div class="muted">No matches yet.</div>'; return; }
    // Sort: live first, then newest createdAt desc
    matches.sort((a,b)=>{
      if(a.status === 'live' && b.status !== 'live') return -1;
      if(b.status === 'live' && a.status !== 'live') return 1;
      return (b.createdAt||'').localeCompare(a.createdAt||'');
    });

    fixturesRoot.innerHTML = '';
    matches.forEach(m=>{
      const el = document.createElement('div');
      el.className = 'match' + (m.status==='live' ? ' live' : '');
      el.innerHTML = `
        <div style="display:flex;gap:12px;align-items:center;">
          <div class="team">
            <img src="${m.home?.logoUrl || 'pfl-logo.png'}" class="tlogo" alt="home">
            <div>
              <div class="tname">${m.home?.name||'Home'}</div>
              <div class="coach">${m.home?.coach ? 'Coach: ' + m.home.coach : ''}</div>
            </div>
          </div>
          <div class="score">${(m.home?.score||0)} ‚Äî ${(m.away?.score||0)}</div>
          <div class="team">
            <div>
              <div class="tname" style="text-align:right">${m.away?.name||'Away'}</div>
              <div class="coach" style="text-align:right">${m.away?.coach? 'Coach: ' + m.away.coach:''}</div>
            </div>
            <img src="${m.away?.logoUrl || 'aog-logo.png'}" class="tlogo" alt="away">
          </div>
        </div>
        <div style="display:flex;justify-content:space-between; margin-top:8px; align-items:center;">
          <div class="meta">${m.status === 'live' ? '<strong style="color:'+getComputedStyle(document.documentElement).getPropertyValue('--gold')+'">LIVE</strong>' : (m.status || '') } ‚Ä¢ ${new Date(m.createdAt||'').toLocaleString()}</div>
          <div class="events">${(m.events && m.events.length) ? (m.events.slice(0,3).map(e=>`${e.minute} ${e.type} ${e.team? ('('+ (e.team==='A'?m.home?.name:m.away?.name) +')') : ''} ‚Äî '+e.desc).join(' ‚Ä¢ ') ) : 'No events yet'}</div>
        </div>
      `;
      fixturesRoot.appendChild(el);
    });
  }

  // real-time listen
  listenMatches((matches)=>{
    renderMatches(matches || []);
  });

</script>
</body>
</html>dates. Admin password stored only on this device.</div>
    </footer>
  </div>
</div>

<script>
/* -------------------- State & Persistence -------------------- */
const STORAGE_KEY = 'pfl_live_state_v2';
const PASS_KEY = 'pfl_admin_pass_v2';
let state = {
  teamA: { name:'Team A', coach:'‚Äî', players:[], logo:'', score:0},
  teamB: { name:'Team B', coach:'‚Äî', players:[], logo:'', score:0},
  competitionLogo: '',
  events: [],
  matchStatus: 'Not started',
  matchTime: "0'"
};

function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function loadState(){ const s = localStorage.getItem(STORAGE_KEY); if(s) state = JSON.parse(s); }
function clearAll(){ localStorage.removeItem(STORAGE_KEY); /* keep admin pass */ state = {
  teamA: { name:'Team A', coach:'‚Äî', players:[], logo:'', score:0},
  teamB: { name:'Team B', coach:'‚Äî', players:[], logo:'', score:0},
  competitionLogo: '', events: [], matchStatus:'Not started', matchTime:"0'"}; saveState(); renderAll(); }

/* -------------------- Elements -------------------- */
const teamANameEl = document.getElementById('teamAName');
const teamBNameEl = document.getElementById('teamBName');
const teamALogoEl = document.getElementById('teamALogo');
const teamBLogoEl = document.getElementById('teamBLogo');
const scoreEl = document.getElementById('score');
const teamACoachEl = document.getElementById('teamACoach');
const teamBCoachEl = document.getElementById('teamBCoach');
const teamAPlayersEl = document.getElementById('teamAPlayers');
const teamBPlayersEl = document.getElementById('teamBPlayers');
const eventFeed = document.getElementById('eventFeed');
const matchStatusEl = document.getElementById('matchStatus');
const matchTimeEl = document.getElementById('matchTime');
const siteLogoEl = document.getElementById('siteLogo');

/* admin elements */
const loginBtn = document.getElementById('loginBtn');
const adminPassInput = document.getElementById('adminPass');
const toggleAdminBtn = document.getElementById('toggleAdminBtn');
const adminArea = document.getElementById('adminArea');
const setupSection = document.getElementById('setupSection');
const teamANameInput = document.getElementById('teamANameInput');
const teamBNameInput = document.getElementById('teamBNameInput');
const teamACoachInput = document.getElementById('teamACoachInput');
const teamBCoachInput = document.getElementById('teamBCoachInput');
const teamAPlayersInput = document.getElementById('teamAPlayersInput');
const teamBPlayersInput = document.getElementById('teamBPlayersInput');
const teamALogoInput = document.getElementById('teamALogoInput');
const teamBLogoInput = document.getElementById('teamBLogoInput');
const siteLogoInput = document.getElementById('siteLogoInput');
const siteLogoPreview = document.getElementById('siteLogoPreview');
const saveSetup = document.getElementById('saveSetup');
const clearStorageBtn = document.getElementById('clearStorage');
const resetBtn = document.getElementById('resetBtn');

/* quick events */
const goalA = document.getElementById('goalA');
const goalB = document.getElementById('goalB');
const redA = document.getElementById('redA');
const redB = document.getElementById('redB');
const yellowA = document.getElementById('yellowA');
const yellowB = document.getElementById('yellowB');
const assistA = document.getElementById('assistA');
const assistB = document.getElementById('assistB');
const subA = document.getElementById('subA');
const subB = document.getElementById('subB');

const addEventBtn = document.getElementById('addEventBtn');
const addSubBtn = document.getElementById('addSubBtn');
const eventMinute = document.getElementById('eventMinute');
const eventDesc = document.getElementById('eventDesc');

let adminVisible = false;

/* -------------------- Initialize -------------------- */
(function init(){
  // ensure admin password exists locally (set default to Rowland12# if none)
  if(!localStorage.getItem(PASS_KEY)){ localStorage.setItem(PASS_KEY, 'Rowland12#'); }
  loadState();
  saveState();
  renderAll();
})();

/* -------------------- Admin handling -------------------- */
function getPass(){ return localStorage.getItem(PASS_KEY); }
function checkPass(p){ return p === getPass(); }
loginBtn.addEventListener('click', ()=>{
  const p = adminPassInput.value.trim();
  if(!p){ alert('Enter password.'); return; }
  if(checkPass(p)){
    adminPassInput.value = '';
    setupSection.style.display = 'block';
    alert('Admin unlocked (local only).');
    populateInputsFromState();
  } else {
    alert('Wrong password.');
  }
});
toggleAdminBtn.addEventListener('click', ()=>{
  adminVisible = !adminVisible;
  adminArea.classList.toggle('show', adminVisible);
  if(!adminVisible) setupSection.style.display = 'none';
});

/* -------------------- File inputs -------------------- */
function readFileAsDataURL(file, cb){
  const r = new FileReader();
  r.onload = e => cb(e.target.result);
  r.readAsDataURL(file);
}
siteLogoInput.addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  readFileAsDataURL(f, (data)=>{ state.competitionLogo = data; siteLogoEl.src = data; siteLogoPreview.innerHTML = '<img src="'+data+'" style="width:64px;height:64px;border-radius:8px"/>'; saveState(); });
});
teamALogoInput.addEventListener('change',(e)=>{
  const f = e.target.files[0]; if(!f) return;
  readFileAsDataURL(f,(data)=>{ state.teamA.logo = data; renderAll(); saveState(); });
});
teamBLogoInput.addEventListener('change',(e)=>{
  const f = e.target.files[0]; if(!f) return;
  readFileAsDataURL(f,(data)=>{ state.teamB.logo = data; renderAll(); saveState(); });
});

/* -------------------- Setup save/clear -------------------- */
saveSetup.addEventListener('click', ()=>{
  state.teamA.name = teamANameInput.value.trim() || 'Team A';
  state.teamA.coach = teamACoachInput.value.trim() || '‚Äî';
  state.teamA.players = teamAPlayersInput.value.split('\n').map(s=>s.trim()).filter(Boolean);
  state.teamB.name = teamBNameInput.value.trim() || 'Team B';
  state.teamB.coach = teamBCoachInput.value.trim() || '‚Äî';
  state.teamB.players = teamBPlayersInput.value.split('\n').map(s=>s.trim()).filter(Boolean);
  saveState(); renderAll(); alert('Setup saved.');
});
clearStorageBtn.addEventListener('click', ()=>{ if(confirm('Clear all saved data on this device?')) clearAll(); });
resetBtn.addEventListener('click', ()=>{ if(confirm('Reset scores and events for this match?')){ state.teamA.score=0; state.teamB.score=0; state.events=[]; state.matchStatus='Not started'; saveState(); renderAll(); } });

/* -------------------- Events & actions -------------------- */
function nowStamp(){ const d = new Date(); return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0'); }
function pushEvent(ev){ state.events.unshift(ev); saveState(); renderEvents(); }
function flashTeam(side){ const el = side==='A'? teamANameEl : teamBNameEl; el.classList.remove('flash-red'); void el.offsetWidth; el.classList.add('flash-red'); }

function addGoal(team){
  if(team==='A'){ state.teamA.score++; pushEvent({type:'Goal', team:'A', minute: eventMinute.value.trim() || nowStamp(), desc: `${state.teamA.name} scored`}); flashTeam('A'); playGoalSound(); }
  else { state.teamB.score++; pushEvent({type:'Goal', team:'B', minute: eventMinute.value.trim() || nowStamp(), desc: `${state.teamB.name} scored`}); flashTeam('B'); playGoalSound(); }
  saveState(); renderAll();
}
function addCard(team, color){
  pushEvent({type: color+' card', team, minute: eventMinute.value.trim() || nowStamp(), desc: `${team==='A'?state.teamA.name:state.teamB.name} ‚Äî ${color} card`});
  if(color==='Red') flashTeam(team);
  saveState(); renderAll();
}
function addAssist(team){
  pushEvent({type:'Assist', team, minute: eventMinute.value.trim() || nowStamp(), desc: `${team==='A'?state.teamA.name:state.teamB.name} ‚Äî Assist`});
  saveState(); renderEvents();
}
function addSub(team){
  const desc = prompt('Substitution (Out: Player ‚Äî In: Player)');
  if(!desc) return;
  pushEvent({type:'Substitution', team, minute: eventMinute.value.trim() || nowStamp(), desc});
  saveState(); renderAll();
}
function addManual(){
  const minute = eventMinute.value.trim() || nowStamp();
  const desc = eventDesc.value.trim();
  if(!desc){ alert('Enter description'); return; }
  pushEvent({type:'Event', team:'', minute, desc});
  eventDesc.value=''; eventMinute.value='';
}

/* Quick button listeners */
goalA.addEventListener('click', ()=>addGoal('A'));
goalB.addEventListener('click', ()=>addGoal('B'));
redA.addEventListener('click', ()=>addCard('A','Red'));
redB.addEventListener('click', ()=>addCard('B','Red'));
yellowA.addEventListener('click', ()=>addCard('A','Yellow'));
yellowB.addEventListener('click', ()=>addCard('B','Yellow'));
assistA.addEventListener('click', ()=>addAssist('A'));
assistB.addEventListener('click', ()=>addAssist('B'));
subA.addEventListener('click', ()=>addSub('A'));
subB.addEventListener('click', ()=>addSub('B'));
addEventBtn.addEventListener('click', addManual);
addSubBtn.addEventListener('click', ()=>{ const desc = prompt('Substitution (Out: Player ‚Äî In: Player)'); if(desc) { pushEvent({type:'Substitution', team:'', minute: eventMinute.value.trim() || nowStamp(), desc}); saveState(); renderAll(); } });

/* -------------------- Rendering -------------------- */
function renderAll(){
  teamANameEl.textContent = state.teamA.name;
  teamBNameEl.textContent = state.teamB.name;
  teamACoachEl.textContent = 'Coach: ' + (state.teamA.coach || '‚Äî');
  teamBCoachEl.textContent = 'Coach: ' + (state.teamB.coach || '‚Äî');
  teamAPlayersEl.textContent = (state.teamA.players||[]).slice(0,5).join(', ') || '‚Äî';
  teamBPlayersEl.textContent = (state.teamB.players||[]).slice(0,5).join(', ') || '‚Äî';
  scoreEl.textContent = `${state.teamA.score} ‚Äî ${state.teamB.score}`;
  matchStatusEl.textContent = state.matchStatus || 'Not started';
  matchTimeEl.textContent = state.matchTime || "0'";
  siteLogoEl.src = state.competitionLogo || '';
  teamALogoEl.src = state.teamA.logo || '';
  teamBLogoEl.src = state.teamB.logo || '';
  renderEvents();
}
function renderEvents(){
  eventFeed.innerHTML = '';
  if(!state.events.length){ eventFeed.innerHTML = '<div class="muted">No events yet.</div>'; return; }
  state.events.forEach(ev=>{
    const div = document.createElement('div'); div.className='ev';
    const teamName = ev.team==='A'? state.teamA.name : ev.team==='B'? state.teamB.name : '';
    div.innerHTML = `<div style="display:flex; justify-content:space-between; gap:8px;"><div><strong>${ev.type}</strong>${teamName? ' ‚Äî ' + teamName : ''}</div><div class="muted">${ev.minute}</div></div>
      <div style="margin-top:6px;">${ev.desc}</div>`;
    eventFeed.appendChild(div);
  });
}

/* -------------------- Sound -------------------- */
let audioCtx = null;
function playGoalSound(){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const ctx = audioCtx; const t = ctx.currentTime;
    const freqs = [523.25,659.25,783.99];
    freqs.forEach((f,i)=>{
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type='sine'; o.frequency.value=f;
      g.gain.value=0.0001;
      o.connect(g); g.connect(ctx.destination);
      o.start(t + i*0.03);
      g.gain.setValueAtTime(0.0001, t + i*0.03);
      g.gain.exponentialRampToValueAtTime(0.08, t + 0.03 + i*0.03);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.62 + i*0.03);
      o.stop(t + 0.62 + i*0.03);
    });
  }catch(e){ console.warn('Audio failed', e); }
}

/* -------------------- Helpers -------------------- */
function populateInputsFromState(){
  teamANameInput.value = state.teamA.name || '';
  teamBNameInput.value = state.teamB.name || '';
  teamACoachInput.value = state.teamA.coach || '';
  teamBCoachInput.value = state.teamB.coach || '';
  teamAPlayersInput.value = (state.teamA.players||[]).join('\n');
  teamBPlayersInput.value = (state.teamB.players||[]).join('\n');
  siteLogoPreview.innerHTML = state.competitionLogo? '<img src="'+state.competitionLogo+'" style="width:64px;height:64px;border-radius:8px"/>':'Preview';
}

/* allow quick save on Enter for manual event */
eventDesc.addEventListener('keyup', (e)=>{ if(e.key==='Enter') addManual(); });

/* expose small CSV export for events */
window.exportEventsCSV = function(){
  if(!state.events.length){ alert('No events'); return; }
  const rows = [['Time','Type','Team','Desc']];
  state.events.slice().reverse().forEach(ev=> rows.push([ev.minute,ev.type,ev.team,ev.desc]));
  const csv = rows.map(r=> r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
  const url = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  const a = document.createElement('a'); a.href=url; a.download='pfl_events.csv'; a.click();
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>
